-- Table: account
CREATE TABLE account (
    id VARCHAR(12) PRIMARY KEY COMMENT 'CCCD làm ID của tài khoản',
    username VARCHAR(255) NOT NULL UNIQUE,
    email VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    role ENUM('USER','ADMIN','MODERATOR') NOT NULL DEFAULT 'USER',
    last_login DATETIME,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Table: login_history (theo dõi lịch sử đăng nhập)
CREATE TABLE login_history (
    id INT AUTO_INCREMENT PRIMARY KEY,
    account_id VARCHAR(12) NOT NULL,
    login_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    logout_time DATETIME,
    ip_address VARCHAR(50),
    device_info VARCHAR(255),
    login_status ENUM('SUCCESS', 'FAILED') NOT NULL,
    FOREIGN KEY (account_id) REFERENCES account(id)
);

-- Table: person (Thông tin người dân; sử dụng CCCD làm ID)
CREATE TABLE person (
    id VARCHAR(12) PRIMARY KEY COMMENT 'CCCD làm ID của người dân',
    full_name VARCHAR(100) NOT NULL,
    birth_date DATE,
    gender ENUM('MALE','FEMALE'),
    address VARCHAR(255),
    phone_number VARCHAR(20)
);

-- Table: car (Xe hơi)
CREATE TABLE car (
    id INT AUTO_INCREMENT PRIMARY KEY,
    license_plate VARCHAR(20) NOT NULL UNIQUE,
    brand VARCHAR(50),
    color VARCHAR(30),
    owner_id VARCHAR(12) NOT NULL,
    FOREIGN KEY (owner_id) REFERENCES person(id)
);

-- Table: motorcycle (Xe máy)
CREATE TABLE motorcycle (
    id INT AUTO_INCREMENT PRIMARY KEY,
    license_plate VARCHAR(20) NOT NULL UNIQUE,
    brand VARCHAR(50),
    color VARCHAR(30),
    owner_id VARCHAR(12) NOT NULL,
    FOREIGN KEY (owner_id) REFERENCES person(id)
);



-- Table: car_violations (Vi phạm dành riêng cho xe hơi)
CREATE TABLE car_violations (
    id INT AUTO_INCREMENT PRIMARY KEY,
    violation_time DATETIME NOT NULL,
    violation_type VARCHAR(255) NOT NULL,
    description TEXT,
    penalty_type VARCHAR(255),
    fine_amount DECIMAL(10,2),
    violator_id VARCHAR(12) NOT NULL, -- Người vi phạm (trỏ đến person)
    officer_id VARCHAR(12) NOT NULL,  -- Cán bộ xử lý (trỏ đến account)
    car_id INT NOT NULL,
    FOREIGN KEY (violator_id) REFERENCES person(id),
    FOREIGN KEY (officer_id) REFERENCES account(id),
    FOREIGN KEY (car_id) REFERENCES car(id)
);

-- Table: motorcycle_violations (Vi phạm dành riêng cho xe máy)
CREATE TABLE motorcycle_violations (
    id INT AUTO_INCREMENT PRIMARY KEY,
    violation_time DATETIME NOT NULL,
    violation_type VARCHAR(255) NOT NULL,
    description TEXT,
    penalty_type VARCHAR(255),
    fine_amount DECIMAL(10,2),
    violator_id VARCHAR(12) NOT NULL,
    officer_id VARCHAR(12) NOT NULL,
    motorcycle_id INT NOT NULL,
    FOREIGN KEY (violator_id) REFERENCES person(id),
    FOREIGN KEY (officer_id) REFERENCES account(id),
    FOREIGN KEY (motorcycle_id) REFERENCES motorcycle(id)
);

-- Table: car_scan_logs (Lịch sử quét dành riêng cho xe hơi)
CREATE TABLE car_scan_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    scan_timestamp DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    license_plate VARCHAR(20) NOT NULL,
    operator_id VARCHAR(12) NOT NULL, -- Người vận hành (trỏ đến account)
    car_id INT,
    FOREIGN KEY (operator_id) REFERENCES account(id),
    FOREIGN KEY (car_id) REFERENCES car(id)
);

-- Table: motorcycle_scan_logs (Lịch sử quét dành riêng cho xe máy)
CREATE TABLE motorcycle_scan_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    scan_timestamp DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    license_plate VARCHAR(20) NOT NULL,
    operator_id VARCHAR(12) NOT NULL,
    motorcycle_id INT,
    FOREIGN KEY (operator_id) REFERENCES account(id),
    FOREIGN KEY (motorcycle_id) REFERENCES motorcycle(id)
);

-- Thêm các chỉ mục (indexes) để tối ưu truy vấn



-- Indexes cho bảng car_scan_logs
CREATE INDEX idx_car_scan_time ON car_scan_logs(scan_timestamp);
CREATE INDEX idx_car_scan_plate ON car_scan_logs(license_plate);

-- Indexes cho bảng motorcycle_scan_logs
CREATE INDEX idx_mc_scan_time ON motorcycle_scan_logs(scan_timestamp);
CREATE INDEX idx_mc_scan_plate ON motorcycle_scan_logs(license_plate);

-- Indexes cho các bảng quan hệ
CREATE INDEX idx_car_owner ON car(owner_id);
CREATE INDEX idx_motorcycle_owner ON motorcycle(owner_id);
CREATE INDEX idx_face_person ON face_data(person_id);



______________________________________________________________________________________________________________________
Các table mới thêm vào:


-- Tạo mới table car_violations-report
CREATE TABLE car_violations_report (
    id INT AUTO_INCREMENT PRIMARY KEY,
    license_plate VARCHAR(20) NOT NULL,
    violator_id VARCHAR(12) NOT NULL, -- Thống nhất độ dài với person.id
    officer_id VARCHAR(12) NOT NULL,  -- Thống nhất độ dài với account.id
    report_time DATETIME NOT NULL,
    report_location TEXT NOT NULL,
    penalty_type TEXT NOT NULL,
    resolution_deadline DATETIME NOT NULL,
    -- Khóa ngoại liên kết đến bảng car qua biển số
    FOREIGN KEY (license_plate) REFERENCES car(license_plate),
    -- Khóa ngoại liên kết đến người vi phạm (person)
    FOREIGN KEY (violator_id) REFERENCES person(id),
    -- Khóa ngoại liên kết đến tài khoản cán bộ xử lý (account)
    FOREIGN KEY (officer_id) REFERENCES account(id)
);


-- Tạo mới table car_violation_details
CREATE TABLE car_violation_details (
    id INT AUTO_INCREMENT PRIMARY KEY,
    violation_id INT NOT NULL,
    violation_type VARCHAR(100) NOT NULL,
    fine_amount DECIMAL(12, 2) NOT NULL,
    FOREIGN KEY (violation_id) REFERENCES car_violations_report(id) ON DELETE CASCADE
);


CREATE TABLE motorcycle_violations_report (
    id INT AUTO_INCREMENT PRIMARY KEY,
    license_plate VARCHAR(20) NOT NULL,
    violator_id VARCHAR(12) NOT NULL, -- Thống nhất độ dài với person.id
    officer_id VARCHAR(12) NOT NULL,  -- Thống nhất độ dài với account.id
    report_time DATETIME NOT NULL,
    report_location TEXT NOT NULL,
    penalty_type TEXT NOT NULL,
    resolution_deadline DATETIME NOT NULL,
    -- Khóa ngoại liên kết đến bảng motorcycle qua biển số
    FOREIGN KEY (license_plate) REFERENCES motorcycle(license_plate),
    -- Khóa ngoại liên kết đến người vi phạm (person)
    FOREIGN KEY (violator_id) REFERENCES person(id),
    -- Khóa ngoại liên kết đến tài khoản cán bộ xử lý (account)
    FOREIGN KEY (officer_id) REFERENCES account(id)
);


-- Tạo mới table car_violation_details
CREATE TABLE motorcycle_violation_details (
    id INT AUTO_INCREMENT PRIMARY KEY,
    violation_id INT NOT NULL,
    violation_type VARCHAR(100) NOT NULL,
    fine_amount DECIMAL(12, 2) NOT NULL,
    FOREIGN KEY (violation_id) REFERENCES motorcycle_violations_report(id) ON DELETE CASCADE
);


--> Xóa table: motorcycle_violation , car_violation , face_data ( Minh điều chỉnh lại xóa bớt mấy file code liên quan tới mấy table này nha)
